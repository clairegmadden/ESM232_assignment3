---
title: "assignment3"
author: "Claire Madden"
date: "4/27/2020"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

library(tidyverse)
library(sensitivity)
library(pse)
library(here)


clim_data <- read_csv(here("Data", "clim.csv"))

source("../R/yield_anom.R")
```


Adjust your almond model to  output ONLY the mean almond yield anomoly IF the users sets parameter (e.g mean_only = TRUE))


Perform a sensitivity analysis of how mean anomaly varies ALL of the parameters used in the yield model  

Assume parameters are normally distribute with standard deviation of 20% mean value

```{r parameters}

# considering all parameters in the yield_anom model
factors <- c("tn1", "tn2", "p1", "p2", "int")

# number of parameter sets to run
nsets = 500

# set distributions

q = c("qnorm", "qnorm", "qnorm", "qnorm", "qnorm")

q.arg = list(list(mean = -0.015, sd = 0.2),
             list(mean = -0.0046, sd = 0.2),
             list(mean = -0.07, sd= 0.2),
             list(mean = 0.0043, sd = 0.2),
             list(mean = 0.28, sd = 0.2))
```

```{r LHS}


# generate samples from LHS
sens1 <- LHS(NULL, factors, nsets, q, q.arg)

sens_pars <- get.data(sens1)


# create matrix to store results
sens1_results <- matrix(nrow = nsets, ncol = 1)

# read in input data in set up code chunk as 'clim_data'


# notice that MoreArgs is used for inputs that are the same for each set
df_almond = mapply(FUN=yield_anom, 
                   tn1=sens_pars$tn1, 
                   tn2=sens_pars$tn2,
                   p1=sens_pars$p1,
                   p2=sens_pars$p2,
                   int=sens_pars$int,
                   MoreArgs=list(clim_data=clim_data))


# use unlist to get a matrix
sens1_results <- matrix((unlist(df_almond)), ncol=1, byrow=TRUE)

colnames(sens1_results)=c("mean_anom_LHS")


# to take advantage of LHS/pse functions for plotting interesting information we can send results back
sens1 = pse::tell(sens1, t(sens1_results), res.names=c("mean_anom_LHS"))
pse::plotscatter(sens1, col="blue", cex=5) #p2!

pse::plotprcc(sens1) #p2! most sensitive, p1 is next, then tn2, tn1 and then int
sens1$prcc


# we can also plot results in interesting ways
# turn sens1_results into a data frame - easier access to R plotting functions

sens1_LHS = as.data.frame(sens1_results) #bind with sobel later

```


```{r Sobel}

np=500

# generate two examples of random number from parmeter distributions

tn1 = rnorm(mean = -0.015, sd = 0.2, n=np)
tn2 = rnorm(mean = -0.0046, sd = 0.2, n=np)
p1 = rnorm(mean = -0.07, sd= 0.2, n=np)
p2 = rnorm(mean = 0.0043, sd = 0.2, n=np)
int = rnorm(mean = 0.28, sd = 0.2, n=np)

# Sample 1

X1 = cbind.data.frame(tn1, tn2, p1, p2, int)

tn1 = rnorm(mean = -0.015, sd = 0.2, n=np)
tn2 = rnorm(mean = -0.0046, sd = 0.2, n=np)
p1 = rnorm(mean = -0.07, sd= 0.2, n=np)
p2 = rnorm(mean = 0.0043, sd = 0.2, n=np)
int = rnorm(mean = 0.28, sd = 0.2, n=np)

# Sample 2

X2 = cbind.data.frame(tn1, tn2, p1, p2, int)


sens1_sobel = sobol2007(model = NULL, X1, X2, nboot = 100)

# run model for all parameter sets
sens1_results_sobel = mapply(FUN=yield_anom,  
                             tn1=sens1_sobel$X$tn1,
                             tn2=sens1_sobel$X$tn2,
                             p1=sens1_sobel$X$p1, 
                             p2=sens1_sobel$X$p2, 
                             int=sens1_sobel$X$int,
                             MoreArgs=list(clim_data=clim_data))


sens1_sobel = sensitivity::tell(sens1_sobel,sens1_results_sobel, sens1_results_sobel.names="ga")



```

Rank the parameters in term of their sensitivity
```{r Rank}



```


Graph uncertainty in mean yield anomaly across all parameter uncertainty (boxplot and cummulative distribution of the output).

```{r Graph 500}

# we can also plot results in interesting ways
# turn sens_results into a data frame - easier access to R plotting functions

sens_results = as.data.frame(sens_results)
ggplot(sens_results, aes(minyield, maxyield))+geom_point()+labs(y="Max Yield (as anomoly)", "Min Yield (as anomoly")


# add uncertainty bounds on our estimates
tmp = sens_results %>% gather(value="value", key="yield")
ggplot(tmp, aes(yield, value, col=yield))+geom_boxplot()+labs(y="Yield (as anomoly)")

# notice the difference
ggplot(tmp, aes(yield, value, col=yield))+geom_boxplot()+labs(y="Yield (as anomoly)")+facet_wrap(~yield, scales="free")


```



Repeat using twice as many parameter sets as you did in your first sensitivity analysis - and look at how this changes the sensitivity results

```{r Graph 1000}



```


Submit R markdown and short write up describing what you learned from the sensitivity analysis. Please submit your markdown as an .html or PDF. 



